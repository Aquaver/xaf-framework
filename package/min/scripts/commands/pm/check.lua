local a,b=...local c=require("component")local d=require("event")local e=require("filesystem")local f=require("xaf/utility/httpstream")local g=require("xaf/utility/jsonparser")local h=require("xaf/core/xafcore")local i=h:getTableInstance()local j=_G._XAF;local k=j and j._VERSION or''if b.h==true or b.help==true then print("----------------------------------")print("-- XAF Package Manager - Manual --")print("----------------------------------")print("  >> NAME")print("    >> xaf-pm check - Package update checking program")print()print("  >> SYNOPSIS")print("    >> xaf-pm check")print("    >> xaf-pm check [-h | --help]")print("    >> xaf-pm check [-p | --package] <identifier>")print()print("  >> DESCRIPTION")print("    >> This programs is used for checking remote version of installed package and returning information about update possibility.")os.exit()end;if b.p==true or b.package==true then local l="aquaver.github.io"local m="xaf-framework"local n="xaf-packages"local o="data"local p="pm-update.info"local q=a[1]local r=tostring(a[1])local s=nil;local t=''local u=''local v=0;local w=''local x=''local y=''if q==nil or r==''then print("--------------------------------------")print("-- XAF Package Manager - Controller --")print("--------------------------------------")print("  >> Invalid package name to update check")print("  >> Use 'xaf-pm check [-p | --package]' again with proper package name")os.exit()else t=e.concat(l,m,o,p)u=e.concat(l,n,r)end;if e.exists(t)==false then print("--------------------------------------")print("-- XAF Package Manager - Controller --")print("--------------------------------------")print("  >> Cannot continue update checking procedure")print("  >> Unable to find package source list file")print("  >> Missing file name: "..p)os.exit()else s=i:loadFromFile(t)end;if e.exists(u)==false then print("--------------------------------------")print("-- XAF Package Manager - Controller --")print("--------------------------------------")print("  >> Package with entered name does not exist")print("  >> Use 'xaf-pm check [-p | --package]' again with proper name")os.exit()else if s[r]==nil then print("--------------------------------------")print("-- XAF Package Manager - Controller --")print("--------------------------------------")print("  >> Unable to find package identifier in update data file")print("  >> Despite this it exists in XAF PM packages directory")print("  >> Try removing this package and installing it again")os.exit()else y=s[r]v=string.find(y,':')w=string.sub(y,v+1,-1)x=string.sub(y,1,v-1)end end;if c.isAvailable("internet")==false then print("--------------------------------------")print("-- XAF Package Manager - Controller --")print("--------------------------------------")print("  >> Internet card component is not available")print("  >> Package Manager cannot connect to target repository")os.exit()else print("--------------------------------------")print("-- XAF Package Manager - Controller --")print("--------------------------------------")print("  >> Internet card component found")print("  >> Trying to connect to target repository...")end;local z="https://api.github.com/repos/"local A="/git/trees/master"local B="?recursive=1"local C=false;print("    >> Searching for package '"..r.."' in category: "..w)print("    >> Package source repository: "..x)local D=z..x..A..B;local E=c.getPrimary("internet")local F=f:new(E,D)if F:connect()==true then local G=''local H=nil;local I={}for J in F:getData()do G=G..J end;F:disconnect()H=g:new()I=H:parse(G)for K=1,#I["tree"]do if I["tree"][K]["path"]==w..'/'..r then print("      >> Package found")print("      >> Retrieving description data")C=true;sourceAddress=I["tree"][K]["url"]D=I["tree"][K]["url"]F=f:new(E,D)if F:connect()==true then G=''I={}for J in F:getData()do G=G..J end;F:disconnect()I=H:parse(G)if#I["tree"]==2 and I["tree"][1]["path"]=="_bin"and I["tree"][2]["path"]=="_config"then local L="https://raw.githubusercontent.com/"local M="_config/repository.info"local N="/master/"D=L..x..N..M;F=f:new(E,D)if F:connect()==true then local O=''local P={}for J in F:getData()do O=O..J end;P=i:loadFromString(O)O=''if k>P["repository-xaf"]then local Q="https://raw.githubusercontent.com/"local R="/_config/package.info"local S="/master/"D=Q..x..S..w..'/'..r..R;F=f:new(E,D)if F:connect()==true then local T=''local U={}for J in F:getData()do T=T..J end;U=i:loadFromString(T)T=''if U["package-description"]and U["package-identifier"]and U["package-index"]and U["package-owner"]and U["package-title"]and U["package-version"]and U["package-xaf"]then if r==U["package-identifier"]then local V=e.concat(u,"_config","package.info")local W=i:loadFromFile(V)local X=W["package-version"]local Y=U["package-version"]if Y>X then print("        >> Successfully retrieved information about '"..r)print("        >> An update is available for this package")print("        >> Remote version: "..Y.." (local version: "..X..')')print("        >> You can now use 'xaf-pm update "..r.."' to update this package")print("        >> Update checking procedure has been finished")else print("        >> Successfully retrieved information about: "..r)print("        >> No update is available, you have the latest version of this package ("..X..')')print("        >> Updated checking procedure has been finished")end;os.exit()else print("        >> Package identifier mismatch detected")print("        >> Identifier from configuration file and package directory (entered name) must be equal")print("        >> This package cannot be updated")os.exit()end else print("        >> Invalid package description file detected")print("        >> If this message appears again, contact the package owner")print("        >> Update checking procedure has been interrupted")os.exit()end else print("        >> Cannot retrieve package description file")print("        >> Ensure you have not lost internet access")print("        >> Update checking procedure has been interrupted")os.exit()end else print("        >> Repository '"..x.."' forces requirement to have newer XAF version")print("        >> Detected local API version: "..k.." (required by this repository is: "..P["repository-xaf"]..')')print("        >> Please update XAF via 'xaf update' before updating this package")print("        >> Update checking procedure has been interrupted")os.exit()end else print("        >> Cannot retrieve repository description file")print("        >> Ensure you have not lost internet access")print("        >> Update checking procedure has been interrupted")os.exit()end else print("        >> Invalid XAF PM package structure")print("        >> Encountered unexpected files in package master directory")print("        >> This package cannot be updated")os.exit()end else print("        >> Cannot connect to package content tree")print("        >> Ensure you have not lost internet access")print("        >> Update checking procedure has been interrupted")os.exit()end end end;if C==false then print("      >> Cannot find package '"..r.."' on repository: "..x)print("      >> This package might be removed")print("      >> If this package physically exists, try reinstalling it manually")end else print("      >> Cannot connect to '"..x.."' repository")print("      >> Ensure you have not lost internet access")print("      >> Update checking procedure has been interrupted")end;os.exit()end;print("--------------------------------------")print("-- XAF Package Manager - Controller --")print("--------------------------------------")print("  >> Package update checking program")print("  >> Use 'xaf-pm check [-h | --help]' for command manual")
